<!DOCTYPE html>
<html lang="id">
<head>
    <title>Hazi Admin - Multi Date</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background: #eef2f5; }
        .header { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .date-group label { display: block; font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        input[type="date"] { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; outline: none; }
        
        .slot-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-avail { background: #dcfce7; color: #166534; }
        .btn-booked { background: #fee2e2; color: #991b1b; }
        .btn-reset { background: #1e293b; color: white; padding: 12px; width: 100%; margin-top: 20px; border-radius: 8px; }
        
        .url-box { background: #0f172a; color: #4ade80; padding: 15px; border-radius: 8px; margin-bottom: 20px; word-break: break-all; font-family: monospace; font-size: 12px; border: 1px solid #334155; }
        #loading { text-align: center; color: #64748b; font-size: 12px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="url-box" id="cf-url">Loading URL...</div>

    <div class="header">
        <div class="date-group">
            <label>Pilih Tanggal Booking:</label>
            <input type="date" id="datePicker" onchange="refresh()">
        </div>
        <div id="loading">‚è≥ Sinkronisasi Data...</div>
    </div>

    <div id="slots-list"></div>
    <button class="btn btn-reset" onclick="resetSlots()">RESET TANGGAL INI</button>

    <script>
        const now = new Date();
        now.setHours(now.getHours() + 7);
        document.getElementById('datePicker').value = now.toISOString().slice(0, 10);

        async function getTunnelUrl() {
            try {
                const res = await fetch('/tunnel-url?t=' + Date.now());
                const data = await res.json();
                document.getElementById('cf-url').innerText = data.url;
            } catch (e) { document.getElementById('cf-url').innerText = "Gagal ambil URL"; }
        }

        async function refresh() {
            const date = document.getElementById('datePicker').value;
            const container = document.getElementById('slots-list');
            const loader = document.getElementById('loading');
            
            loader.style.display = 'block';
            container.style.opacity = '0.5';

            try {
                const res = await fetch(`/slots?date=${date}&t=${Date.now()}`);
                const data = await res.json();
                
                container.innerHTML = '';
                const times = ["10:00", "11:00", "12:00", "13:00", "14:00"];

                times.forEach(time => {
                    const status = data.slots[time];
                    const btnClass = status === 'available' ? 'btn-avail' : 'btn-booked';
                    const nextStatus = status === 'available' ? 'booked' : 'available';
                    
                    const el = document.createElement('div');
                    el.className = 'slot-item';
                    el.innerHTML = `
                        <span style="font-weight: bold; font-size:18px">${time}</span>
                        <button class="btn ${btnClass}" onclick="toggle('${time}', '${nextStatus}')">
                            ${status.toUpperCase()}
                        </button>
                    `;
                    container.appendChild(el);
                });
            } catch (e) {
                container.innerHTML = '<div style="text-align:center;color:red">Gagal koneksi ke server</div>';
            } finally {
                loader.style.display = 'none';
                container.style.opacity = '1';
            }
        }

        async function toggle(time, status) {
            const date = document.getElementById('datePicker').value;
            await fetch('/slots', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, time, status })
            });
            refresh();
        }

        async function resetSlots() {
            const date = document.getElementById('datePicker').value;
            if(confirm(`Reset jadwal tanggal ${date}?`)) {
                await fetch('/reset', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date })
                });
                refresh();
            }
        }

        getTunnelUrl();
        refresh();
    </script>
</body>
</html>
